{
    "contents" : "rm(list = ls())\nlibrary(\"coda\")\nlibrary(rjson)\ndir_list = c(\"01KEN_CXR_AGE_0\",\"01KEN_CXR_AGE_1\",\"02GAM_CXR_AGE_0\",\"02GAM_CXR_AGE_1\",\n             \"03MAL_CXR_AGE_0\",\"03MAL_CXR_AGE_1\",\"04ZAM_CXR_AGE_0\",\"04ZAM_CXR_AGE_1\",\n             \"05SAF_CXR_AGE_0\",\"05SAF_CXR_AGE_1\",\"06THA_CXR_AGE_0\",\"06THA_CXR_AGE_1\",\n             \"07BAN_CXR_AGE_0\",\"07BAN_CXR_AGE_1\")\ndir_list1 = substr(dir_list,3,15)\ndir_list2 = substr(dir_list,1,5)\njson.prep = list()\njson.prep.raw = list()\n\n#### a function to match each model's result to the desired order:####\nj=1\nDIR_NPLCM = paste0(\"C:\\\\Users\\\\WFu\\\\Dropbox (PERCH)\\\\PQM EXPERIMENT DATASETS\\\\ARCHIVE\\\\PQM_RESULTS_20141122\\\\\",dir_list2[j],\"\\\\\",dir_list[j])\nmodel_options  <- dget(paste(DIR_NPLCM,\"model_options.txt\",sep=\"/\"))\npathogen_list = c(model_options$pathogen_list,model_options$pathogen_SSonly_list)\nDIR_pathogen_displayorder_lookup <- \"C:\\\\PQ_MODEL\\\\pathogen_displayorder_lookup.csv\"\npathogen_displayorder_lookup <- read.csv(DIR_pathogen_displayorder_lookup)\nf <- pathogen_displayorder_lookup$Pathogen\ndisplay_order <- as.character(levels(f))[f]\nlookup <- function(disp_order, union_nm){\n  ord_union <- rep(NA,length(union_nm))\n  incre <- 0\n  for (j in seq_along(disp_order)){\n    if (disp_order[j]%in% union_nm){\n      incre <- incre + 1\n      ord_union[incre] <- which(union_nm==disp_order[j])\n    }\n  }\n  list(ord_union,union_nm[ord_union])\n}\norder <- lookup(display_order,pathogen_list)[[1]]\nnewlist = lookup(display_order,pathogen_list)[[2]]\norder_new = 33-lookup(pathogen_list,newlist)[[1]]\n\n\n\n#####Prepare raw data#####\nfor (j in seq_along(dir_list)) {\n  DIR_NPLCM = paste0(\"C:\\\\Users\\\\WFu\\\\Dropbox (PERCH)\\\\PQM EXPERIMENT DATASETS\\\\ARCHIVE\\\\PQM_RESULTS_20141122\\\\\",dir_list2[j],\"\\\\\",dir_list[j])\n  \n  model_options  <- dget(paste(DIR_NPLCM,\"model_options.txt\",sep=\"/\"))\n  res_nplcm <- read.coda(paste(DIR_NPLCM,\"coda1.txt\",sep=\"/\"),\n                         paste(DIR_NPLCM,\"codaIndex.txt\",sep=\"/\"),quiet=TRUE)\n  bugs.dat <- dget(paste(DIR_NPLCM,\"data.txt\",sep=\"/\"))\n  Nd = bugs.dat$Nd\n  # prepare results for individual diagnosis:\n  d1_nplcm  = nrow(res_nplcm)\n  d2_nplcm  = Nd\n  Icat_nplcm = array(NA,c(d1_nplcm,d2_nplcm))\n  for (i in 1:d2_nplcm){\n    SubVarName = paste(\"Icat\",\"[\",i,\"]\",sep=\"\")\n    Icat_nplcm[,i] = res_nplcm[,SubVarName]\n  }\n  rev(strsplit(DIR_NPLCM,\"[\\\\]\")[[1]])[1]\n  \n  #\n  pathogen_list = c(model_options$pathogen_list,model_options$pathogen_SSonly_list)\n  # Prepare individual diagnosis table\n  path.prop.iter = apply(Icat_nplcm, 1, function(x) prop.table(table(x)))\n  freqs.list <- mapply(data.frame,Words=seq_along(path.prop.iter),path.prop.iter,\n                       SIMPLIFY=FALSE,MoreArgs=list(stringsAsFactors=FALSE))\n  freqs.df <- do.call(rbind,freqs.list)\n  res <- reshape(freqs.df,timevar=\"Words\",idvar=\"x\",direction=\"wide\")\n  x.levels = (as.numeric(levels(res$x)))\n  row.names(res)=sapply(x.levels,function(x) pathogen_list[x])\n  res.sort=res[order(as.numeric(levels(res$x))),]\n  res.ggplots = data.frame(t(data.matrix(res.sort)[,-1]))\n  res.ggplots[is.na(res.ggplots)] <- 0\n  res.ggplots <-round(res.ggplots,4)\n  # merge with pathogen_list and make sure every pathogen get a column\n  if (ncol(res.ggplots)<length(pathogen_list)){\n    path.df = as.data.frame(t(array(0,length(pathogen_list[[i]]))))\n    colnames(path.df)=pathogen_list[[i]]\n    res.ggplots = rbind.fill(path.df,res.ggplots)[-1,]\n  }\n  json.prep[[j]] <- as.array(colMeans(res.ggplots))[order]\n  row.names(json.prep[[j]])=NULL\n  json.prep.raw[[j]] = res.ggplots[order]\n}\nnames(json.prep.raw)=dir_list\nn=length(dir_list)\njson.prep.raw[[n+1]] = newlist\njson.prep.raw[[n+2]] = newlist\njson.prep.raw[[n+3]] = c(32:1)\njson.prep.raw[[n+4]] = dir_list\ndir_list1[n+1]= \"pathogen\"\ndir_list1[n+2]= \"abbrev\"\ndir_list1[n+3]= \"rank\"\ndir_list1[[n+4]] = \"rawlist\"\nnames(json.prep.raw)= dir_list\n\n\n\n################# Exhausive list#####\nCI_list = list()\n## Prepare 2.5% and 97.5% for 101 scenario\nsite = c(\"KEN\",\"GAM\",\"MAL\",\"ZAM\",\"SAF\",\"THA\",\"BAN\")\nfor (s in c(0:6)) {\n  CI_list[[s+1]] = list()\n  for (w in c(0:100)){\n    CI_list[[s+1]][[w+1]] = list()\n\n    result_w = (json.prep.raw[[2*s+1]]*w+json.prep.raw[[2*s+2]]*(100-w))/100\n    res_w_2.5= as.array(apply(result_w, 2, function(x) quantile(x, .025)))\n    res_w_97.5= as.array(apply(result_w, 2, function(x) quantile(x, .975)))\n    res_w_mean= as.array(apply(result_w, 2, mean))\n    res_w_sd= as.array(apply(result_w, 2, sd))\n    row.names(res_w_2.5)=NULL\n    row.names(res_w_97.5)=NULL\n    row.names(res_w_mean)=NULL\n    row.names(res_w_sd)=NULL\n\n    CI_list[[s+1]][[w+1]][[1]]=res_w_2.5\n    CI_list[[s+1]][[w+1]][[2]]=res_w_97.5\n    CI_list[[s+1]][[w+1]][[3]]=res_w_mean\n    CI_list[[s+1]][[w+1]][[4]]=res_w_sd\n    names( CI_list[[s+1]][[w+1]])=c(\"p025\",\"p975\",\"mean\",\"sd\")\n  }\n  names(CI_list[[s+1]])=paste(\"W\",c(0:100),sep=\"\")\n}\nnames(CI_list)=site\n\nn=length(dir_list)\njson.prep[[n+1]] = newlist\njson.prep[[n+2]] = newlist\njson.prep[[n+3]] = c(32:1)\njson.prep[[n+4]] = dir_list1\ndir_list1[n+1]= \"pathogen\"\ndir_list1[n+2]= \"abbrev\"\ndir_list1[n+3]= \"rank\"\ndir_list1[[n+4]] = \"rawlist\"\nnames(json.prep)= dir_list1\njson.prep.new = c(json.prep,CI_list)\n\n#######Create JSON#########\nrequest.body <- toJSON(json.prep.new)\nsink(\"C:\\\\Users\\\\WFu\\\\Google Drive\\\\PERCH\\\\2_PQ_MODEL\\\\PQM_Project\\\\EtioComp\\\\perchdata.json\")\ncat(request.body)\nsink()\n\n#######Create JSON#########\nrequest.body <- toJSON(json.prep.raw)\nsink(\"C:\\\\Users\\\\WFu\\\\Google Drive\\\\PERCH\\\\2_PQ_MODEL\\\\PQM_Project\\\\EtioComp\\\\perchdata.json\")\ncat(request.body)\nsink()\n\n\n\n\n",
    "created" : 1423591278398.000,
    "dirty" : false,
    "encoding" : "UTF-8",
    "folds" : "",
    "hash" : "3934581400",
    "id" : "575D75BD",
    "lastKnownWriteTime" : 1423599663,
    "path" : "C:/Users/WFu/Google Drive/PERCH/2_PQ_MODEL/PQM_Project/EtioComp/dataprep.R",
    "project_path" : "dataprep.R",
    "properties" : {
        "tempName" : "Untitled1"
    },
    "source_on_save" : false,
    "type" : "r_source"
}